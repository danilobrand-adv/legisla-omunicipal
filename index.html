<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busca de Leis Municipais</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
        }
        /* Estilos adicionais para a tabela, se necess√°rio, al√©m do Tailwind */
        th, td {
            @apply px-4 py-2 text-left; /* Tailwind classes for padding and alignment */
        }
        th {
            @apply bg-blue-100 text-blue-800 font-semibold; /* Tailwind classes for header styling */
        }
        tr:nth-child(even) {
            @apply bg-gray-50; /* Zebra striping for table rows */
        }
        tr:hover {
            @apply bg-blue-50; /* Hover effect for table rows */
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-6 flex flex-col items-center">

    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl border border-gray-200">
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-8">
            <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">
                üîé Sistema de Busca de Leis Municipais
            </span>
        </h1>

        <div class="mb-6 text-center">
            <p id="loadingMessage" class="text-blue-600 mt-2 hidden">Carregando dados da planilha...</p>
            <p id="errorMessage" class="text-red-600 mt-2 hidden"></p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Campo de busca por Ano -->
            <div class="flex flex-col">
                <label for="ano" class="text-gray-700 text-sm font-semibold mb-2">Ano:</label>
                <input
                    type="text"
                    id="ano"
                    placeholder="Ex: 2025"
                    class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out shadow-sm w-full"
                >
            </div>

            <!-- Campo de busca por Palavra-chave -->
            <div class="flex flex-col">
                <label for="palavra" class="text-gray-700 text-sm font-semibold mb-2">Palavra-chave:</label>
                <input
                    type="text"
                    id="palavra"
                    placeholder="Ex: or√ßamento"
                    class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out shadow-sm w-full"
                >
            </div>
        </div>

        <button onclick="buscarLeis()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out mb-8">
            Buscar
        </button>

        <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b-2 pb-2 border-blue-300">
            Resultados da Busca (<span id="resultsCount">0</span> leis encontradas):
        </h2>

        <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
            <table id="tabelaResultados" class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th>Ano</th>
                        <th>N√∫mero</th>
                        <th>Texto</th>
                        <th>Link</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Resultados ser√£o inseridos aqui -->
                </tbody>
            </table>
            <p id="noResultsMessage" class="text-gray-600 text-center py-8 hidden">Nenhuma lei encontrada.</p>
        </div>
    </div>

    <script>
        // URL da planilha CSV fornecido pelo usu√°rio
        const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7ollrDhKhlyCtPnTQsMlFK2AmzNXA32LM1P7pvCzuJvaW6c23glm5-wbJWjrdzAKWydX2W81NidKK/pub?output=csv";
        let dados = [];

        const tabelaResultadosBody = document.querySelector("#tabelaResultados tbody");
        const resultsCountSpan = document.getElementById("resultsCount");
        const loadingMessage = document.getElementById("loadingMessage");
        const errorMessage = document.getElementById("errorMessage");
        const noResultsMessage = document.getElementById("noResultsMessage");

        // Fun√ß√£o para exibir mensagens de erro
        function showErrorMessage(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            loadingMessage.classList.add('hidden');
            noResultsMessage.classList.add('hidden');
        }

        // Fun√ß√£o para ocultar mensagens de erro
        function hideErrorMessage() {
            errorMessage.classList.add('hidden');
        }

        async function carregarDados() {
            loadingMessage.classList.remove('hidden');
            hideErrorMessage();
            tabelaResultadosBody.innerHTML = ''; // Limpa resultados anteriores
            resultsCountSpan.textContent = '0';
            noResultsMessage.classList.add('hidden'); // Esconde a mensagem de "nenhuma lei" enquanto carrega

            try {
                const resposta = await fetch(URL_CSV);
                if (!resposta.ok) {
                    throw new Error(`Erro de rede ou URL inv√°lido: ${resposta.status} ${resposta.statusText}`);
                }
                const texto = await resposta.text();
                dados = csvParaJSON(texto);
                console.log("‚úÖ Dados carregados:", dados); // Para depura√ß√£o
                buscarLeis(); // Exibe todos os dados ou os dados filtrados se j√° houver termos de busca
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                showErrorMessage(`Falha ao carregar a planilha: ${error.message}. Verifique o URL e as permiss√µes de publica√ß√£o.`);
                tabelaResultadosBody.innerHTML = `<tr><td colspan="4" class="text-center text-red-600">Erro ao carregar dados.</td></tr>`;
                resultsCountSpan.textContent = '0';
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        function csvParaJSON(csv) {
            const linhas = csv.split("\n")
                .map(l => l.trim())
                .filter(l => l); // Remove apenas linhas vazias, n√£o linhas que come√ßam com v√≠rgula

            if (linhas.length === 0) return [];

            // Encontra a linha do cabe√ßalho (a que cont√©m 'ano')
            const linhaCabecalhoIndex = linhas.findIndex(l => l.toLowerCase().includes("ano"));
            if (linhaCabecalhoIndex === -1) {
                console.error("Cabe√ßalho 'ano' n√£o encontrado no CSV.");
                return [];
            }

            const cabecalhos = linhas[linhaCabecalhoIndex].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
                                    .map(h => h.replace(/^"|"$/g, "").trim().toLowerCase());

            return linhas.slice(linhaCabecalhoIndex + 1).map(linha => {
                const valores = linha.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const obj = {};
                cabecalhos.forEach((coluna, i) => {
                    obj[coluna] = valores[i] ? valores[i].replace(/^"|"$/g, "").trim() : "";
                });
                return obj;
            });
        }

        function buscarLeis() {
            const anoFiltro = document.getElementById("ano").value.trim();
            const palavraFiltro = document.getElementById("palavra").value.trim().toLowerCase();

            const filtrados = dados.filter(item => {
                const anoDoItem = item["ano"] || ""; // Garante que √© uma string para compara√ß√£o
                const textoDoItem = item["texto"] || "";

                const anoOk = !anoFiltro || (anoDoItem === anoFiltro);
                const palavraOk = !palavraFiltro || textoDoItem.toLowerCase().includes(palavraFiltro);
                return anoOk && palavraOk;
            });

            exibirLeis(filtrados);
        }

        function exibirLeis(lista) {
            tabelaResultadosBody.innerHTML = "";
            noResultsMessage.classList.add('hidden'); // Esconde a mensagem de "nenhuma lei" por padr√£o

            if (!lista.length) {
                noResultsMessage.classList.remove('hidden');
                resultsCountSpan.textContent = '0';
                return;
            }

            lista.forEach(item => {
                const linha = document.createElement("tr");
                linha.innerHTML = `
                    <td>${item["ano"] || ""}</td>
                    <td>${item["n√∫mero"] || item["numero"] || ""}</td>
                    <td>${item["texto"] || ""}</td>
                    <td><a href="${item["link da lei"] || item["link"] || "#"}" target="_blank" class="text-blue-600 hover:underline">üìÑ Acessar</a></td>
                `;
                tabelaResultadosBody.appendChild(linha);
            });
            resultsCountSpan.textContent = lista.length;
        }

        // Adiciona event listeners para os campos de busca para filtrar em tempo real
        document.getElementById("ano").addEventListener("input", buscarLeis);
        document.getElementById("palavra").addEventListener("input", buscarLeis);

        // Carrega os dados ao iniciar a p√°gina
        carregarDados();
    </script>
</body>
</html>
